name: 🤖 Auto Merge

on:
  pull_request:
    types: [labeled, unlabeled, synchronize, opened, edited, ready_for_review, reopened]

jobs:
  auto-merge:
    name: 🤖 Auto Merge PR
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.draft == false &&
      (
        contains(github.event.pull_request.labels.*.name, 'auto-merge') ||
        contains(github.event.pull_request.labels.*.name, 'dependencies') ||
        contains(github.event.pull_request.labels.*.name, 'hotfix')
      )
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: ⏳ Wait for CI checks
      uses: fountainhead/action-wait-for-check@v1.1.0
      id: wait-for-ci
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        checkName: "✅ All Tests Passed"
        ref: ${{ github.event.pull_request.head.sha }}
        timeoutSeconds: 1800 # 30 minutes
        intervalSeconds: 30
        
    - name: ✅ Auto merge if CI passes
      if: steps.wait-for-ci.outputs.conclusion == 'success'
      uses: pascalgn/merge-action@v0.15.6
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        merge_method: squash
        merge_commit_message: "🤖 Auto-merge: {pull_request_title} (#{pull_request_number})"
        
    - name: 📝 Comment on successful merge
      if: steps.wait-for-ci.outputs.conclusion == 'success'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '🤖 **Auto-merged successfully!** ✅\n\nAll tests passed and the pull request has been automatically merged into main branch.\n\n🎉 Thanks for your contribution!'
          })
          
    - name: ❌ Comment on failed merge
      if: steps.wait-for-ci.outputs.conclusion != 'success'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '❌ **Auto-merge failed!**\n\nCI checks did not pass. Please review the test results and fix any issues before this PR can be merged.\n\n🔍 Check the [CI results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for more details.'
          })